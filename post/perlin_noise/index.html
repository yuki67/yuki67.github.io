<!DOCTYPE html>
<html lang="en">
    <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.30.2" />

  <title>パーリンノイズ &middot; yuki&#39;s blog</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yuki67.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yuki67.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yuki67.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  

  <link rel="shortcut icon" href="https://yuki67.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="stylesheet" href="https://yuki67.github.io/css/custom.css">

    <body>
        <div id="layout">
            
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yuki67.github.io/">yuki's blog</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yuki67.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yuki67.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yuki67.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yfkutydt" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yuki67" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>by yuki</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>

            <div id="main">


<div class="header">
  <h1>パーリンノイズ</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2017-08-17</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://yuki67.github.io/tags/python">python</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://yuki67.github.io/tags/%E3%82%B3%E3%83%BC%E3%83%89%E7%BD%AE%E3%81%8D%E5%A0%B4">コード置き場</a>
    
  </div>
  
  

</div>

  <p>書いたので。</p>

<p></p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">1</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">2</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">3</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">4</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">5</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">6</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic"># モジュールのインポート</span>
<span style="color:#666">%</span>matplotlib inline
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">math</span> <span style="color:#a2f;font-weight:bold">import</span> floor
<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">itertools</span> <span style="color:#a2f;font-weight:bold">import</span> product
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">numpy</span> <span style="color:#a2f;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">np</span>
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">matplotlib.pyplot</span> <span style="color:#a2f;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">plt</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="シンプルなノイズ">シンプルなノイズ</h2>

<p>格子点ごとにランダムに値を割り振って、一般の座標における値を線形補間で求めるノイズを考える。</p>

<p>パーリンノイズのコードが多少複雑になるので、このノイズのコードもクラスを使って書く。
なおランダムな値を格子点に割り振るときには <a href="https://yuki67.github.io/posts/random_pick/">この記事</a> で紹介したハッシュ法を使った。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">14</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">15</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">16</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">17</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">18</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">19</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">20</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">21</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">22</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">23</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">24</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">25</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">26</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">27</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">28</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">29</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">30</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">31</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">32</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">33</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">34</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">35</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">36</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">37</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">38</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">39</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">lerp</span>(a, b, t):
    <span style="color:#a2f;font-weight:bold">return</span> a <span style="color:#666">+</span> (b <span style="color:#666">-</span> a) <span style="color:#666">*</span> t

<span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Simple</span>():
    weights <span style="color:#666">=</span> np<span style="color:#666">.</span>random<span style="color:#666">.</span>random(<span style="color:#666">256</span>)
    rand_index <span style="color:#666">=</span> np<span style="color:#666">.</span>zeros(<span style="color:#666">512</span>, dtype<span style="color:#666">=</span>np<span style="color:#666">.</span>int8)
    <span style="color:#a2f;font-weight:bold">for</span> i, rand <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">enumerate</span>(np<span style="color:#666">.</span>random<span style="color:#666">.</span>permutation(<span style="color:#666">256</span>)):
      rand_index[i] <span style="color:#666">=</span> rand
      rand_index[i <span style="color:#666">+</span> <span style="color:#666">256</span>] <span style="color:#666">=</span> rand

    <span style="color:#a2f">@staticmethod</span>
    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">hash</span>(i, j):
        <span style="color:#a2f;font-weight:bold">return</span> Simple<span style="color:#666">.</span>rand_index[Simple<span style="color:#666">.</span>rand_index[i] <span style="color:#666">+</span> j]

    <span style="color:#080;font-style:italic"># 点の周りの格子点の線形補間を求める</span>
    <span style="color:#a2f">@staticmethod</span>
    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">noise</span>(x, y):
        ix <span style="color:#666">=</span> floor(x) <span style="color:#666">%</span> <span style="color:#666">256</span>
        iy <span style="color:#666">=</span> floor(y) <span style="color:#666">%</span> <span style="color:#666">256</span>
        dx <span style="color:#666">=</span> x <span style="color:#666">-</span> floor(x)
        dy <span style="color:#666">=</span> y <span style="color:#666">-</span> floor(y)
        y0 <span style="color:#666">=</span> lerp(Simple<span style="color:#666">.</span>weights[Simple<span style="color:#666">.</span><span style="color:#a2f">hash</span>(ix,         iy)],
                  Simple<span style="color:#666">.</span>weights[Simple<span style="color:#666">.</span><span style="color:#a2f">hash</span>(ix <span style="color:#666">+</span> <span style="color:#666">1</span>,     iy)], dx)
        y1 <span style="color:#666">=</span> lerp(Simple<span style="color:#666">.</span>weights[Simple<span style="color:#666">.</span><span style="color:#a2f">hash</span>(ix,     iy <span style="color:#666">+</span> <span style="color:#666">1</span>)],
                  Simple<span style="color:#666">.</span>weights[Simple<span style="color:#666">.</span><span style="color:#a2f">hash</span>(ix <span style="color:#666">+</span> <span style="color:#666">1</span>, iy <span style="color:#666">+</span> <span style="color:#666">1</span>)], dx)
        <span style="color:#a2f;font-weight:bold">return</span> lerp(y0, y1, dy)

<span style="color:#080;font-style:italic"># 画像の大きさは(512, 512)</span>
width, height <span style="color:#666">=</span> <span style="color:#666">512</span>, <span style="color:#666">512</span>
canvas <span style="color:#666">=</span> np<span style="color:#666">.</span>zeros((width, height))
<span style="color:#080;font-style:italic"># 格子点を16個配置する</span>
w <span style="color:#666">=</span> <span style="color:#666">16</span>
canvas <span style="color:#666">=</span> np<span style="color:#666">.</span>array([[Simple<span style="color:#666">.</span>noise(x, y)
                    <span style="color:#a2f;font-weight:bold">for</span> x <span style="color:#a2f;font-weight:bold">in</span> np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, w, width)]
                   <span style="color:#a2f;font-weight:bold">for</span> y <span style="color:#a2f;font-weight:bold">in</span> np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, w, height)])

<span style="color:#080;font-style:italic"># matplotlibを使って表示</span>
fig, ax <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots(figsize<span style="color:#666">=</span>(<span style="color:#666">10</span>, <span style="color:#666">10</span>))
ax<span style="color:#666">.</span>imshow(canvas, cmap<span style="color:#666">=</span>plt<span style="color:#666">.</span>cm<span style="color:#666">.</span>binary)</code></pre></td></tr></table>
</div>
</div>

<figure >
    
        <img src="https://yuki67.github.io/ox-hugo/simple_noise.png" />
    
    
</figure>


<p>この場合、元になった格子が目立ってノイズっぽくならない。</p>

<h2 id="パーリンノイズ">パーリンノイズ</h2>

<p>パーリンノイズを使うと自然なノイズを高速に作れる。</p>

<p>パーリンノイズの工夫を挙げると</p>

<ul>
<li>格子点に割り振るのは重みではなく勾配ベクトル \(\vec{a}_{ij}\)</li>
<li>格子点の重みは固定ではなく、計算している座標 \((x, y)\) から求める

<ul>
<li>\(noise(x, y)\) 計算するとき、格子点 \(i, j\) の重みは \((i-x, j-x) \cdot \vec{a}_{ij}\)</li>
</ul></li>
<li>格子の端で値が急に変化するのを避けるために、\((x, y)\)の小数部分を <code>fade</code> 関数にかけてから線形補間をする</li>
</ul>

<p>がある。勾配ベクトルとの内積使って重みを求めることで格子点の周りでも値が散らばるようになり、ノイズが自然になる。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">14</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">15</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">16</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">17</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">18</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">19</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">20</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">21</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">22</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">23</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">24</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">25</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">26</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">27</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">28</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">29</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">30</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">31</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">32</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">33</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">34</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">35</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">36</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">37</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">38</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">39</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">40</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">41</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">42</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">43</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">44</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">45</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">46</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">47</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">48</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">49</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">50</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">51</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">52</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">53</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">54</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">55</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">56</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">57</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">58</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">59</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Perlin</span>():
    slopes <span style="color:#666">=</span> <span style="color:#666">2</span> <span style="color:#666">*</span> np<span style="color:#666">.</span>random<span style="color:#666">.</span>random((<span style="color:#666">256</span>, <span style="color:#666">2</span>)) <span style="color:#666">-</span> <span style="color:#666">1</span>
    rand_index <span style="color:#666">=</span> np<span style="color:#666">.</span>zeros(<span style="color:#666">512</span>, dtype<span style="color:#666">=</span>np<span style="color:#666">.</span>int8)
    <span style="color:#a2f;font-weight:bold">for</span> i, rand <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">enumerate</span>(np<span style="color:#666">.</span>random<span style="color:#666">.</span>permutation(<span style="color:#666">256</span>)):
      rand_index[i] <span style="color:#666">=</span> rand
      rand_index[i <span style="color:#666">+</span> <span style="color:#666">256</span>] <span style="color:#666">=</span> rand

    <span style="color:#a2f">@staticmethod</span>
    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">hash</span>(i, j):
        <span style="color:#080;font-style:italic"># 前提条件: 0 &lt;= i, j &lt;= 256</span>
        <span style="color:#a2f;font-weight:bold">return</span> Perlin<span style="color:#666">.</span>rand_index[Perlin<span style="color:#666">.</span>rand_index[i] <span style="color:#666">+</span> j]

    <span style="color:#a2f">@staticmethod</span>
    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">fade</span>(x):
        <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">6</span> <span style="color:#666">*</span> x<span style="color:#666">**</span><span style="color:#666">5</span> <span style="color:#666">-</span> <span style="color:#666">15</span> <span style="color:#666">*</span> x <span style="color:#666">**</span> <span style="color:#666">4</span> <span style="color:#666">+</span> <span style="color:#666">10</span> <span style="color:#666">*</span> x<span style="color:#666">**</span><span style="color:#666">3</span>

    <span style="color:#a2f">@staticmethod</span>
    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">weight</span>(ix, iy, dx, dy):
        <span style="color:#080;font-style:italic"># 格子点(ix, iy)に対する(ix + dx, iy + dy)の重みを求める</span>
        ix <span style="color:#666">%=</span> <span style="color:#666">256</span>
        iy <span style="color:#666">%=</span> <span style="color:#666">256</span>
        ax, ay <span style="color:#666">=</span> Perlin<span style="color:#666">.</span>slopes[Perlin<span style="color:#666">.</span><span style="color:#a2f">hash</span>(ix, iy)]
        <span style="color:#a2f;font-weight:bold">return</span> ax <span style="color:#666">*</span> dx <span style="color:#666">+</span> ay <span style="color:#666">*</span> dy

    <span style="color:#a2f">@staticmethod</span>
    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">noise</span>(x, y):
        ix <span style="color:#666">=</span> floor(x)
        iy <span style="color:#666">=</span> floor(y)
        dx <span style="color:#666">=</span> x <span style="color:#666">-</span> floor(x)
        dy <span style="color:#666">=</span> y <span style="color:#666">-</span> floor(y)

        <span style="color:#080;font-style:italic"># 重みを求める</span>
        w00 <span style="color:#666">=</span> Perlin<span style="color:#666">.</span>weight(ix,     iy,   dx  , dy)
        w10 <span style="color:#666">=</span> Perlin<span style="color:#666">.</span>weight(ix<span style="color:#666">+</span><span style="color:#666">1</span>,   iy, dx<span style="color:#666">-</span><span style="color:#666">1</span>,   dy)
        w01 <span style="color:#666">=</span> Perlin<span style="color:#666">.</span>weight(ix,   iy<span style="color:#666">+</span><span style="color:#666">1</span>,   dx, dy<span style="color:#666">-</span><span style="color:#666">1</span>)
        w11 <span style="color:#666">=</span> Perlin<span style="color:#666">.</span>weight(ix<span style="color:#666">+</span><span style="color:#666">1</span>, iy<span style="color:#666">+</span><span style="color:#666">1</span>, dx<span style="color:#666">-</span><span style="color:#666">1</span>, dy<span style="color:#666">-</span><span style="color:#666">1</span>)

        <span style="color:#080;font-style:italic"># 小数部分を変換する</span>
        wx <span style="color:#666">=</span> Perlin<span style="color:#666">.</span>fade(dx)
        wy <span style="color:#666">=</span> Perlin<span style="color:#666">.</span>fade(dy)

        <span style="color:#080;font-style:italic"># 線形補間して返す</span>
        y0 <span style="color:#666">=</span> lerp(w00, w10, wx)
        y1 <span style="color:#666">=</span> lerp(w01, w11, wx)
        <span style="color:#a2f;font-weight:bold">return</span> (lerp(y0, y1, wy) <span style="color:#666">-</span> <span style="color:#666">1</span>) <span style="color:#666">/</span> <span style="color:#666">2</span> <span style="color:#080;font-style:italic"># 値域を[0, 1]に戻す</span>


<span style="color:#080;font-style:italic"># 画像の大きさは512x512</span>
width, height <span style="color:#666">=</span> <span style="color:#666">512</span>, <span style="color:#666">512</span>
canvas <span style="color:#666">=</span> np<span style="color:#666">.</span>zeros((width, height))
<span style="color:#080;font-style:italic"># 格子点を16個配置する</span>
w <span style="color:#666">=</span> <span style="color:#666">16</span>
canvas <span style="color:#666">=</span> np<span style="color:#666">.</span>array([[Perlin<span style="color:#666">.</span>noise(x, y)
                    <span style="color:#a2f;font-weight:bold">for</span> x <span style="color:#a2f;font-weight:bold">in</span> np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, w, width)]
                   <span style="color:#a2f;font-weight:bold">for</span> y <span style="color:#a2f;font-weight:bold">in</span> np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, w, height)])

<span style="color:#080;font-style:italic"># matplotlibを使って表示</span>
fig, ax <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots(figsize<span style="color:#666">=</span>(<span style="color:#666">10</span>, <span style="color:#666">10</span>))
ax<span style="color:#666">.</span>imshow(canvas, cmap<span style="color:#666">=</span>plt<span style="color:#666">.</span>cm<span style="color:#666">.</span>binary)</code></pre></td></tr></table>
</div>
</div>

<figure >
    
        <img src="https://yuki67.github.io/ox-hugo/perlin.png" />
    
    
</figure>


<p>計算に用いた格子がどこにあるのか分からなくなって、ノイズらしいノイズになる。</p>

<p><code>fade</code> 関数もプロットしておく。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">1</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">2</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">3</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">4</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">5</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, ax <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots(figsize<span style="color:#666">=</span>(<span style="color:#666">5</span>, <span style="color:#666">5</span>))
ax<span style="color:#666">.</span>plot(np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">100</span>), fade(np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">100</span>)), label<span style="color:#666">=</span><span style="color:#b44"></span><span style="color:#b44">&#34;fade(x)&#34;</span>)
ax<span style="color:#666">.</span>grid()
ax<span style="color:#666">.</span>legend()
fig</code></pre></td></tr></table>
</div>
</div>

<figure >
    
        <img src="https://yuki67.github.io/ox-hugo/fade.png" />
    
    
</figure>


<p>この関数は \(x = 0, 1\) で一階、二階の微分係数が0になる。
そのため、値を隣の格子と滑らかにつなげることができる。</p>

<p>画像を作るときの <code>w</code> の値を変化させればノイズの粗さを変えることができる。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style=";border-spacing:0;padding:0;margin:0;border:0;width:100%;overflow:auto;display:block;"><tr><td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 1</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 2</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 3</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 4</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 5</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 6</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 7</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 8</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;"> 9</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">10</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">11</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">12</span><span style="color:#7f7f7f;margin-right:0.4em;padding:00.4em00.4em;display:block;">13</span></code></pre></td>
<td style=";vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, axes <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots(nrows<span style="color:#666">=</span><span style="color:#666">3</span>, ncols<span style="color:#666">=</span><span style="color:#666">2</span>, figsize<span style="color:#666">=</span>(<span style="color:#666">20</span>, <span style="color:#666">30</span>))

width, height <span style="color:#666">=</span> <span style="color:#666">512</span>, <span style="color:#666">512</span>
canvas <span style="color:#666">=</span> np<span style="color:#666">.</span>zeros((width, height))
<span style="color:#a2f;font-weight:bold">for</span> i, j <span style="color:#a2f;font-weight:bold">in</span> product([<span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">2</span>], [<span style="color:#666">0</span>, <span style="color:#666">1</span>]):
  <span style="color:#080;font-style:italic"># wの値を2のべきにする</span>
  w <span style="color:#666">=</span> <span style="color:#666">2</span><span style="color:#666">**</span>(i<span style="color:#666">*</span><span style="color:#666">2</span> <span style="color:#666">+</span> j)
  canvas <span style="color:#666">=</span> np<span style="color:#666">.</span>array([[Perlin<span style="color:#666">.</span>noise(x, y)
                      <span style="color:#a2f;font-weight:bold">for</span> x <span style="color:#a2f;font-weight:bold">in</span> np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, w, width)]
                     <span style="color:#a2f;font-weight:bold">for</span> y <span style="color:#a2f;font-weight:bold">in</span> np<span style="color:#666">.</span>linspace(<span style="color:#666">0</span>, w, height)])
  axes[i, j]<span style="color:#666">.</span>set_title(<span style="color:#b44"></span><span style="color:#b44">&#34;w = &#34;</span> <span style="color:#666">+</span> <span style="color:#a2f">str</span>(w))
  axes[i, j]<span style="color:#666">.</span>imshow(canvas, cmap<span style="color:#666">=</span>plt<span style="color:#666">.</span>cm<span style="color:#666">.</span>binary)
fig</code></pre></td></tr></table>
</div>
</div>

<figure >
    
        <img src="https://yuki67.github.io/ox-hugo/perlin_noise_variations.png" />
    
    
</figure>


<p><code>w</code> の値にかかわらずそれらしいノイズが生成されている。</p>

<p>Ken Perlinの元論文を読むと勾配ベクトルを整数のみにして高速化する方法や
パーリンノイズを元にして別のノイズを作る方法も乗っているがこれはまた今度にする。</p>

<h2 id="参考文献">参考文献</h2>

<p>Physically Based Rendering, Third Edition, 10.6.1 &ldquo;Perlin Noise&rdquo;</p>

<p><a href="http://ai2-s2-pdfs.s3.amazonaws.com/e04d/7772b91a83a901408eb0876bbb7814b1d4b5.pdf">http://ai2-s2-pdfs.s3.amazonaws.com/e04d/7772b91a83a901408eb0876bbb7814b1d4b5.pdf</a></p>

<p><a href="http://mrl.nyu.edu/~perlin/noise/">http://mrl.nyu.edu/~perlin/noise/</a></p>

  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yuki67.github.io/post/inverse_method/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yuki67.github.io/post/inverse_method/">逆関数法</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yuki67.github.io/post/random_pick/">ランダムピック</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yuki67.github.io/post/random_pick/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yuki67.github.io/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-107335237-1', 'auto');
  ga('send', 'pageview');

</script>





</body>
</html>

